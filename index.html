import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { 
  Trophy, BookOpen, Brain, Gauge, Moon, Sun, 
  ChevronRight, LayoutDashboard, RotateCcw, 
  AlertCircle, Clock, Zap, Calculator, Target,
  CheckCircle2, XCircle, Info, ChevronLeft,
  ArrowRight, ShieldCheck, GraduationCap,
  RefreshCw
} from 'lucide-react';

const APP_ID = 'sie_ultra_intensive_v1';

// --- DATA: THE 28-DAY INTENSIVE CURRICULUM ---
const CURRICULUM = {
  1: { d: 1, title: "SEC, SROs & Participants", focus: "Regulatory Entities", content: "Master the hierarchy: SEC (Gov) > SROs (FINRA, MSRB, CBOE). Understand the Broker-Dealer: acting as a 'Broker' (Agency/Commission) vs 'Dealer' (Principal/Markup). Identify SIPC ($500k coverage) and FDIC ($250k)." },
  2: { d: 1, title: "Economics & Monetary Policy", focus: "The Fed", content: "The Fed uses D-O-R-M: Discount Rate, Open Market Operations (most used), Reserve Requirements, and Margin (Reg T). When the Fed buys securities, money supply expands (easing/inflationary). When they sell, it tightens." },
  3: { d: 1, title: "Underwriting & the 1933 Act", focus: "Primary Markets", content: "Securities Act of 1933 (Paper Act) regulates new issues. Cooling-off period (20 days): Only 'Indications of Interest' and 'Red Herrings' allowed. No sales, no deposits, no research reports." },
  4: { d: 2, title: "Equity Securities & Voting", focus: "Common/Preferred", content: "Common stock (residual claim) vs Preferred stock (fixed dividend). Voting: Cumulative (favors small shareholders) vs Statutory (1 vote per share per seat). ADRs allow US investors to buy foreign stocks in USD." },
  5: { d: 2, title: "Debt Fundamentals & Seesaw", focus: "Bonds", content: "Inverse relationship: Interest rates up, bond prices down. Yield hierarchy: At a discount, YTC > YTM > CY > NY. At a premium, NY > CY > YTM > YTC. Accrued interest: 30/360 for corporates/munis." },
  6: { d: 2, title: "Treasuries & Municipal Debt", focus: "Taxation", content: "Treasuries (T-Bills, Notes, Bonds) taxed at Federal level, exempt at State/Local. GO Bonds (voter approval/taxes) vs Revenue Bonds (user fees). Municipal bond interest is usually tax-free at the Federal level." },
  7: { d: 1, title: "Part 1 Intensive Review", focus: "Capital Markets (16%)", content: "Review primary market (issuers) vs secondary market (investors). Roles of clearing agencies (NSCC/DTC) and custodians. Difference between a prime broker and an executing broker." },
  8: { d: 2, title: "Intro to Options (Calls/Puts)", focus: "Derivatives", content: "Call Buyers have the Right to Buy (Bullish). Put Buyers have the Right to Sell (Bearish). Contract = 100 shares. Intrinsic value is 'in-the-money' amount; Time value is the remainder of the premium." },
  9: { d: 2, title: "Hedging & Advanced Options", focus: "Strategy", content: "Protective Puts: Buy a put to protect a long stock (Downside hedge). Covered Calls: Sell a call against long stock (Income/Neutral hedge). Break-even: Call = Strike + Prem, Put = Strike - Prem." },
  10: { d: 2, title: "Mutual Funds & NAV", focus: "Packaged Products", content: "Open-end (Mutual Funds) issue continuous shares, trade at NAV + Sales Charge. Closed-end issue fixed shares, trade on exchanges. ETFs are passive, liquid, and can be traded intraday like stocks." },
  11: { d: 2, title: "Variable Annuities & 1035", focus: "Insurance", content: "Separate account carries investment risk. Accumulation units (buying) vs Annuity units (payout). 1035 Exchange: Tax-free transfer between insurance products. 10% penalty for withdrawal before 59.5." },
  12: { d: 2, title: "REITs, DPPs & Partnerships", focus: "Alternatives", content: "REITs: Must pay out 90% of income. DPPs (Direct Participation Programs) pass through gains AND losses. Focus on illiquidity risk. Limited partners have limited liability but no management control." },
  13: { d: 2, title: "529 Plans & ABLE Accounts", focus: "State Products", content: "529 Plans: After-tax contributions, tax-free growth for education. ABLE: For disabilities (onset before age 26). LGIPs: Short-term investment pools for local governments." },
  14: { d: 2, title: "Part 2 Intensive Review", focus: "Products (44%)", content: "CORE SECTION. Practice the Seesaw and Options labs until BE calculations are second nature. Know that Mutual Funds do not trade on exchanges, but ETFs do." },
  15: { d: 3, title: "Order Types & Spreads", focus: "Trading", content: "Market order (speed) vs Limit order (price). Stop order: Triggered at stop price, then becomes a market order. The 'Spread' is Ask minus Bid. Market makers buy at the Bid and sell at the Ask." },
  16: { d: 3, title: "Customer Accounts & KYC", focus: "Accounts", content: "JTWROS (survivor ownership) vs TIC (estate ownership). KYC (Know Your Customer) requires financial (income/net worth) and non-financial (age/objectives) info. Suitability is the absolute priority." },
  17: { d: 3, title: "Margin: Reg T & Maintenance", focus: "Leverage", content: "Reg T: 50% initial deposit. Maintenance: 25% for Long, 30% for Short. Falling below maintenance triggers a 'House Call'. SMA is 'Buying Power' generated by excess equity." },
  18: { d: 3, title: "IRAs & Retirement Plans", focus: "Retirement", content: "Traditional IRA (Pre-tax, RMDs at 73) vs Roth IRA (After-tax, tax-free growth, no RMDs). ERISA: Sets standards for private corporate plans. Vesting schedules and fiduciary duties." },
  19: { d: 3, title: "AML: SARs & CTRs", focus: "Compliance", content: "Stages: Placement, Layering, Integration. CTR: Cash >$10k. SAR: Suspicious activity >$5k. SARs filed with FinCEN within 30 days. No 'tipping off' the suspect allowed." },
  20: { d: 3, title: "Privacy (Reg S-P) & Calls", focus: "Communication", content: "Reg S-P: Privacy notice at opening and annually. TCPA: No cold calls before 8am/after 9pm. Institutional communication (only for institutions) vs Retail communication (>25 retail people)." },
  21: { d: 3, title: "Market Manipulation", focus: "Prohibited", content: "Insider Trading: Material non-public info. Front-running: Personal trade before client trade. Churning: Excessive volume for fees. Freeriding: Selling before paying for the buy." },
  22: { d: 3, title: "Part 3 Intensive Review", focus: "Trading (31%)", content: "Focus on AML and order types. Settlement: T+1 (Treasuries/Options), T+2 (Corporate/Munis). Regulation T payment is T+4 (S+2)." },
  23: { d: 4, title: "Registration (U4) & SD", focus: "Regulations", content: "Form U4: 10-year employment, 5-year residency. Statutory Disqualification (SD): Felony or securities misdemeanor in last 10 years. Fingerprints required for all registered persons." },
  24: { d: 4, title: "Continuing Education (CE)", focus: "Regulations", content: "Regulatory Element: Required annually on anniversary. Firm Element: Required annually. Failure to complete results in CE Inactive status (no commissions, no functions)." },
  25: { d: 4, title: "Complaints & Gifts", focus: "Regulations", content: "Gifts: $100 limit. Complaints: Must be written to be formal. Records kept 4 years. Selling Away: Private securities trades without firm approval (violation of FINRA rules)." },
  26: { d: 4, title: "Political Contributions (G-37)", focus: "Regulations", content: "MFPs: $250 limit per election if they can vote for candidate. 2-year ban on negotiated municipal business for firm if rule is violated ('Pay to Play')." },
  27: { d: 4, title: "Part 4 Intensive Review", focus: "Regs (9%)", content: "Review U4 disclosures and CE rules. Know the difference between a gift and 'ordinary business entertainment' (which has no dollar limit if RR attends)." },
  28: { d: 2, title: "FINAL STRIKE: MOCK EXAM", focus: "Readiness", content: "105 minutes. 75 scored + 5 unscored. Look for 'Except', 'Always', 'Only'. Use the scratch pad for the Bond Seesaw and Option BE calculations." }
};

// --- DATA: FLASHCARDS ---
const FLASHCARDS = [
  { t: "SRO", d: "Self-Regulatory Organization (FINRA, MSRB). Enforces industry rules." },
  { t: "Statutory Disqualification", d: "Felony or securities misdemeanor conviction within 10 years." },
  { t: "Reg T", d: "Federal Reserve rule: 50% initial margin for securities." },
  { t: "ADR", d: "American Depositary Receipt. Foreign stock trading in US Dollars." },
  { t: "Churning", d: "Excessive trading to generate commissions. Prohibited." },
  { t: "Hypothecation", d: "Pledging securities as collateral for a margin loan." },
  { t: "T+1", d: "Settlement for Treasuries and Options." },
  { t: "T+2", d: "Settlement for Corporate and Municipal bonds/stocks." },
  { t: "Form U5", d: "Termination form filed within 30 days of leaving a firm." },
  { t: "SAR", d: "Suspicious Activity Report. Filed for activity >$5,000." },
  { t: "CTR", d: "Currency Transaction Report. Filed for cash >$10,000." },
  { t: "Wash Sale", d: "Selling at a loss and buying back within 30 days. Loss disallowed." },
  { t: "Cumulative Voting", d: "Favors small shareholders (votes can be concentrated)." },
  { t: "Ex-Dividend Date", d: "One business day before record date. First day stock trades without dividend." },
  { t: "Selling Away", d: "Executing securities trades outside the firm without permission." }
];

// --- DATA: INTENSIVE QUESTION BANK ---
const MASTER_QUESTION_BANK = [
  { id: 1, d: 2, q: "A customer buys 1 ABC Jan 50 Call at 4. What is the break-even price?", a: ["46", "50", "54", "58"], c: 2 },
  { id: 2, d: 2, q: "As interest rates rise, which of the following bonds will decrease most in price?", a: ["1-year T-Bill", "5-year Note", "10-year Bond", "30-year Zero-Coupon Bond"], c: 3 },
  { id: 3, d: 4, q: "An RR is convicted of a felony for shoplifting 8 years ago. Which is true?", a: ["They can remain registered", "They are statutorily disqualified", "They only need to notify the SEC", "No action is needed"], c: 1 },
  { id: 4, d: 3, q: "A SAR must be filed within how many days of discovering suspicious activity?", a: ["10 days", "15 days", "30 days", "90 days"], c: 2 },
  { id: 5, d: 1, q: "Which SRO regulates the municipal bond market but has no enforcement power?", a: ["FINRA", "SEC", "MSRB", "CBOE"], c: 2 },
  { id: 6, d: 2, q: "Which of the following investment companies issues a fixed number of shares and trades on an exchange?", a: ["Mutual Fund", "Closed-end Fund", "UIT", "ETF"], c: 1 },
  { id: 7, d: 3, q: "An investor wants to sell a stock if it falls below 40. They should place a:", a: ["Buy Limit 40", "Sell Limit 40", "Sell Stop 40", "Buy Stop 40"], c: 2 },
  { id: 8, d: 4, q: "The maximum gift allowed to a person at another firm is:", a: ["$50", "$100", "$250", "Unlimited"], c: 1 },
  { id: 9, d: 1, q: "Which of the following describes a 'Broker' acting in an agency capacity?", a: ["Taking a position", "Charging a commission", "Charging a markup", "Acting as a principal"], c: 1 },
  { id: 10, d: 2, q: "A bond is trading at 105. Its Coupon (NY) is 6%. Which is true?", a: ["YTM > 6%", "YTM < 6%", "CY < YTM", "Price is at a discount"], c: 1 }
];

const DOMAINS = {
  1: { n: "Capital Markets", w: 16, c: "text-blue-500", bg: "bg-blue-500" },
  2: { n: "Products & Risks", w: 44, c: "text-purple-500", bg: "bg-purple-500" },
  3: { n: "Trading & Accounts", w: 31, c: "text-emerald-500", bg: "bg-emerald-500" },
  4: { n: "Regulations", w: 9, c: "text-orange-500", bg: "bg-orange-500" }
};

export default function App() {
  const [view, setView] = useState('dashboard');
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [userState, setUserState] = useState({
    completedDays: [],
    bestExam: 0,
    examHistory: [],
    cardIndex: 0
  });

  // Simulator & Lab States
  const [exam, setExam] = useState(null);
  const [labState, setLabState] = useState({ bondRate: 5, optionType: 'long-call', strike: 50, premium: 3, cardFlipped: false });
  const [studyDay, setStudyDay] = useState(1);

  // Persistence
  useEffect(() => {
    const saved = localStorage.getItem(APP_ID);
    if (saved) setUserState(JSON.parse(saved));
  }, []);

  useEffect(() => {
    localStorage.setItem(APP_ID, JSON.stringify(userState));
    if (isDarkMode) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [userState, isDarkMode]);

  // Logic: Weighted Readiness
  const readiness = useMemo(() => {
    let score = 0;
    const domCompleted = { 1: 0, 2: 0, 3: 0, 4: 0 };
    const domTotal = { 1: 7, 2: 7, 3: 8, 4: 6 };

    userState.completedDays.forEach(day => {
      const d = CURRICULUM[day].d;
      domCompleted[d]++;
    });

    Object.keys(DOMAINS).forEach(id => {
      score += (domCompleted[id] / domTotal[id]) * DOMAINS[id].w;
    });
    return Math.min(Math.round(score), 100);
  }, [userState.completedDays]);

  // --- ACTIONS ---
  const startExam = () => {
    const questions = [...MASTER_QUESTION_BANK].sort(() => Math.random() - 0.5);
    setExam({ questions, answers: {}, finished: false, startTime: Date.now() });
    setView('exam');
  };

  const handleExamAnswer = (qIdx, aIdx) => {
    setExam(prev => ({ ...prev, answers: { ...prev.answers, [qIdx]: aIdx } }));
  };

  const submitExam = () => {
    let correct = 0;
    exam.questions.forEach((q, i) => { if (exam.answers[i] === q.c) correct++; });
    const score = Math.round((correct / exam.questions.length) * 100);
    setUserState(prev => ({
      ...prev,
      bestExam: Math.max(prev.bestExam, score),
      examHistory: [{ date: new Date().toLocaleDateString(), score }, ...prev.examHistory].slice(0, 5)
    }));
    setExam(prev => ({ ...prev, finished: true }));
  };

  const markComplete = (day) => {
    if (!userState.completedDays.includes(day)) {
      setUserState(prev => ({ ...prev, completedDays: [...prev.completedDays, day] }));
    }
    if (day < 28) setStudyDay(day + 1);
    else setView('dashboard');
  };

  // UI Helpers
  const ProgressBar = ({ val, color = "bg-blue-600", h = "h-2" }) => (
    <div className={`w-full bg-gray-200 dark:bg-gray-800 rounded-full ${h} overflow-hidden`}>
      <div className={`${color} ${h} transition-all duration-1000`} style={{ width: `${val}%` }} />
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300">
      
      {/* Navigation */}
      <nav className="sticky top-0 z-50 bg-white/90 dark:bg-gray-950/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 px-6 py-4">
        <div className="max-w-6xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => setView('dashboard')}>
            <div className="bg-blue-600 p-2 rounded-lg text-white shadow-lg"><Target size={20} /></div>
            <span className="font-black text-xl tracking-tighter">SIE <span className="text-blue-600">INTENSIVE</span></span>
          </div>
          <div className="flex items-center gap-4 sm:gap-6">
            <button onClick={() => setView('labs')} className="text-xs font-black uppercase flex items-center gap-2 hover:text-blue-600"><Calculator size={16} /> Labs</button>
            <button onClick={() => setView('flashcards')} className="text-xs font-black uppercase flex items-center gap-2 hover:text-blue-600"><Zap size={16} /> Cards</button>
            <div className="h-6 w-px bg-gray-200 dark:bg-gray-800" />
            <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
              {isDarkMode ? <Sun size={20} /> : <Moon size={20} />}
            </button>
          </div>
        </div>
      </nav>

      <main className="max-w-6xl mx-auto p-6 sm:p-10">
        
        {/* DASHBOARD */}
        {view === 'dashboard' && (
          <div className="space-y-12 animate-in fade-in duration-500">
            <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
              <div>
                <h1 className="text-4xl font-black mb-1 tracking-tight">Deployment Ready?</h1>
                <p className="text-gray-500 dark:text-gray-400 font-medium italic">FINRA passing threshold: 70%. Your current status is below.</p>
              </div>
              <button onClick={startExam} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-xl font-black shadow-xl shadow-blue-500/30 transition-all hover:scale-105">
                START EXAM SIMULATOR
              </button>
            </header>

            {/* Overall Score */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 bg-white dark:bg-gray-900 p-8 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-sm relative overflow-hidden">
                <div className="flex justify-between items-end mb-6">
                  <div>
                    <h3 className="text-[10px] font-black text-blue-600 uppercase tracking-[0.2em] mb-2">Weighted Readiness</h3>
                    <div className="text-7xl font-black">{readiness}%</div>
                  </div>
                  <div className={`px-4 py-1.5 rounded-full text-xs font-black ${readiness >= 70 ? 'bg-emerald-500/10 text-emerald-500' : 'bg-gray-100 dark:bg-gray-800 text-gray-500'}`}>
                    {readiness >= 70 ? 'STRIKE AUTHORIZED' : 'TRAINING REQ'}
                  </div>
                </div>
                <ProgressBar val={readiness} h="h-4" color="bg-gradient-to-r from-blue-600 to-indigo-500" />
                <div className="grid grid-cols-2 md:grid-cols-4 gap-6 mt-10">
                  {Object.entries(DOMAINS).map(([id, d]) => (
                    <div key={id}>
                      <div className="text-[9px] font-black text-gray-400 uppercase tracking-widest mb-1">{d.n.split(' ')[0]}</div>
                      <div className={`text-xl font-black ${d.c}`}>{d.w}%</div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-gray-900 p-8 rounded-3xl text-white shadow-2xl flex flex-col justify-between overflow-hidden relative">
                <div className="relative z-10">
                  <h3 className="text-xs font-black uppercase tracking-widest opacity-60 mb-1">High Score</h3>
                  <div className="text-6xl font-black">{userState.bestExam}%</div>
                </div>
                <div className="mt-8 relative z-10 border-t border-white/10 pt-6">
                  <p className="text-[10px] font-black uppercase opacity-40 mb-3 tracking-widest">Recent Logs</p>
                  <div className="space-y-2">
                    {userState.examHistory.length > 0 ? userState.examHistory.slice(0, 3).map((h, i) => (
                      <div key={i} className="flex justify-between text-xs font-bold bg-white/5 p-2 rounded-lg">
                        <span>{h.date}</span>
                        <span>{h.score}%</span>
                      </div>
                    )) : <p className="text-xs opacity-20">No simulations recorded.</p>}
                  </div>
                </div>
                <Trophy size={140} className="absolute -bottom-10 -right-10 opacity-5" />
              </div>
            </div>

            {/* Modules Roadmap */}
            <div className="space-y-6">
              <h3 className="text-2xl font-black flex items-center gap-2"><BookOpen className="text-blue-600" /> Training Roadmap</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {Object.entries(CURRICULUM).map(([day, module]) => (
                  <div 
                    key={day}
                    onClick={() => { setStudyDay(parseInt(day)); setView('study'); }}
                    className={`group p-6 rounded-2xl border transition-all cursor-pointer ${userState.completedDays.includes(parseInt(day)) ? 'bg-emerald-500/5 border-emerald-500/20' : 'bg-white dark:bg-gray-900 border-gray-100 dark:border-gray-800 hover:border-blue-500 shadow-sm'}`}
                  >
                    <div className="flex items-center gap-5">
                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center font-black transition-colors ${userState.completedDays.includes(parseInt(day)) ? 'bg-emerald-500 text-white' : 'bg-gray-100 dark:bg-gray-800 text-gray-400 group-hover:bg-blue-600 group-hover:text-white'}`}>
                        {userState.completedDays.includes(parseInt(day)) ? <CheckCircle2 /> : day}
                      </div>
                      <div className="flex-1 overflow-hidden">
                        <h4 className="font-bold text-sm leading-tight mb-1 truncate">{module.title}</h4>
                        <div className={`text-[9px] font-black uppercase px-2 py-0.5 rounded inline-block ${DOMAINS[module.d].bg} text-white`}>
                          {DOMAINS[module.d].n.split(' ')[0]}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* STUDY MODULE */}
        {view === 'study' && (
          <div className="max-w-3xl mx-auto space-y-10 animate-in slide-in-from-right duration-500">
            <button onClick={() => setView('dashboard')} className="flex items-center gap-2 text-sm font-black text-gray-500 hover:text-blue-600"><ChevronLeft /> Back to Dashboard</button>
            <div className="bg-white dark:bg-gray-900 p-8 sm:p-14 rounded-[3rem] border border-gray-100 dark:border-gray-800 shadow-sm">
              <header className="mb-10">
                <div className="flex gap-3 mb-4">
                  <span className={`text-[10px] font-black px-2 py-1 rounded text-white ${DOMAINS[CURRICULUM[studyDay].d].bg}`}>DOMAIN {CURRICULUM[studyDay].d}</span>
                  <span className="text-gray-400 text-xs font-bold uppercase tracking-widest">{CURRICULUM[studyDay].focus}</span>
                </div>
                <h1 className="text-5xl font-black leading-tight tracking-tighter">{CURRICULUM[studyDay].title}</h1>
              </header>
              <div className="prose dark:prose-invert max-w-none text-2xl leading-relaxed text-gray-700 dark:text-gray-300 font-medium">
                <p className="mb-10 border-l-4 border-blue-600 pl-8">{CURRICULUM[studyDay].content}</p>
                <div className="bg-blue-50 dark:bg-blue-900/10 p-10 rounded-3xl border border-blue-100 dark:border-blue-900/30">
                  <h4 className="text-xs font-black text-blue-600 uppercase tracking-widest mb-6">Training Checkpoint</h4>
                  <button onClick={() => markComplete(studyDay)} className="w-full bg-blue-600 text-white py-5 rounded-2xl font-black text-xl flex items-center justify-center gap-3 shadow-xl shadow-blue-500/20">
                    MARK AS COMPLETED & NEXT <ChevronRight />
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* LABS */}
        {view === 'labs' && (
          <div className="max-w-4xl mx-auto space-y-12 animate-in fade-in duration-500">
            <h1 className="text-5xl font-black text-center tracking-tighter">Logic Labs</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-white dark:bg-gray-900 p-10 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-xl">
                <h3 className="text-2xl font-black mb-10 flex items-center gap-3"><Calculator className="text-purple-600" /> Yield Seesaw</h3>
                <div className="relative py-20 flex flex-col items-center">
                  <div className="w-full h-1 bg-gray-200 dark:bg-gray-800 relative transition-transform duration-700" style={{ transform: `rotate(${(labState.bondRate - 5) * 6}deg)` }}>
                    <div className="absolute -top-12 left-0 -translate-x-1/2 text-center">
                      <span className="text-[10px] font-black text-gray-400">PRICE</span>
                      <div className="text-xl font-black text-blue-600">{labState.bondRate > 5 ? 'DISCOUNT' : 'PREMIUM'}</div>
                    </div>
                    <div className="absolute -top-12 right-0 translate-x-1/2 text-center">
                      <span className="text-[10px] font-black text-gray-400">YIELD</span>
                      <div className="text-xl font-black text-purple-600">{labState.bondRate.toFixed(1)}%</div>
                    </div>
                    <div className="absolute top-0 left-1/2 -translate-x-1/2 w-4 h-10 bg-gray-300 dark:bg-gray-700" />
                  </div>
                  <input type="range" min="2" max="8" step="0.1" value={labState.bondRate} onChange={(e) => setLabState({...labState, bondRate: parseFloat(e.target.value)})} className="w-full mt-24 accent-purple-600" />
                </div>
              </div>
              <div className="bg-white dark:bg-gray-900 p-10 rounded-3xl border border-gray-100 dark:border-gray-800 shadow-xl">
                <h3 className="text-2xl font-black mb-8">Options BE</h3>
                <div className="bg-gray-50 dark:bg-gray-800 p-8 rounded-2xl text-center mb-8">
                  <div className="text-6xl font-black text-blue-600">${labState.optionType.includes('call') ? labState.strike + labState.premium : labState.strike - labState.premium}</div>
                  <span className="text-xs font-black uppercase text-gray-400 mt-4 block">Break-Even Point</span>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-gray-400 uppercase">Strike</label>
                    <input type="number" value={labState.strike} onChange={(e) => setLabState({...labState, strike: parseInt(e.target.value)})} className="w-full p-4 rounded-xl bg-gray-100 dark:bg-gray-700 font-black border-0" />
                  </div>
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-gray-400 uppercase">Premium</label>
                    <input type="number" value={labState.premium} onChange={(e) => setLabState({...labState, premium: parseInt(e.target.value)})} className="w-full p-4 rounded-xl bg-gray-100 dark:bg-gray-700 font-black border-0" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* FLASHCARDS */}
        {view === 'flashcards' && (
          <div className="max-w-2xl mx-auto py-12 space-y-10 animate-in zoom-in duration-500">
            <h1 className="text-5xl font-black text-center tracking-tighter">Combat Cards</h1>
            <div className="h-80 w-full perspective-1000 cursor-pointer" onClick={() => setLabState({...labState, cardFlipped: !labState.cardFlipped})}>
              <div className={`relative w-full h-full transition-transform duration-500 transform-style-3d ${labState.cardFlipped ? 'rotate-y-180' : ''}`}>
                <div className="absolute inset-0 bg-white dark:bg-gray-900 border border-blue-500/20 rounded-[2.5rem] flex flex-col items-center justify-center p-12 backface-hidden shadow-2xl">
                  <span className="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-4">TERM</span>
                  <h2 className="text-4xl font-black text-center leading-tight">{FLASHCARDS[userState.cardIndex].t}</h2>
                </div>
                <div className="absolute inset-0 bg-blue-600 text-white rounded-[2.5rem] flex flex-col items-center justify-center p-12 backface-hidden rotate-y-180 shadow-2xl">
                  <span className="text-[10px] font-black opacity-60 uppercase tracking-widest mb-4">DEFINITION</span>
                  <p className="text-2xl font-bold text-center leading-relaxed">{FLASHCARDS[userState.cardIndex].d}</p>
                </div>
              </div>
            </div>
            <div className="flex justify-between items-center bg-white dark:bg-gray-900 p-4 rounded-3xl border border-gray-100 dark:border-gray-800">
              <button onClick={() => { setLabState({...labState, cardFlipped: false}); setUserState({...userState, cardIndex: (userState.cardIndex - 1 + FLASHCARDS.length) % FLASHCARDS.length})}} className="p-4 rounded-2xl hover:bg-gray-100 dark:hover:bg-gray-800"><ChevronLeft /></button>
              <span className="font-black text-xs text-gray-400">{userState.cardIndex + 1} / {FLASHCARDS.length}</span>
              <button onClick={() => { setLabState({...labState, cardFlipped: false}); setUserState({...userState, cardIndex: (userState.cardIndex + 1) % FLASHCARDS.length})}} className="p-4 px-10 bg-blue-600 text-white rounded-2xl font-black">NEXT</button>
            </div>
          </div>
        )}

        {/* EXAM SIMULATOR */}
        {view === 'exam' && exam && (
          <div className="max-w-3xl mx-auto py-6 space-y-8 animate-in fade-in duration-500">
            <header className="flex justify-between items-center bg-white/90 dark:bg-gray-900/90 backdrop-blur-lg p-6 rounded-3xl border border-gray-100 dark:border-gray-800 sticky top-24 z-40">
              <div className="flex items-center gap-4">
                <div className="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg"><Clock size={24} /></div>
                <div>
                  <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Time Remaining</div>
                  <div className="text-2xl font-black tabular-nums tracking-tighter">105:00</div>
                </div>
              </div>
              {!exam.finished && (
                <button onClick={submitExam} className="bg-gray-950 dark:bg-white text-white dark:text-gray-950 px-8 py-4 rounded-2xl font-black text-sm transition-all hover:scale-105">SUBMIT EXAM</button>
              )}
            </header>

            {!exam.finished ? (
              <div className="space-y-8">
                {exam.questions.map((q, i) => (
                  <div key={q.id} className="bg-white dark:bg-gray-900 p-10 rounded-[2.5rem] border border-gray-100 dark:border-gray-800 shadow-sm">
                    <div className="flex justify-between mb-6">
                      <span className="text-[10px] font-black text-blue-600 uppercase">Question {i + 1}</span>
                      <span className="text-[10px] font-black text-gray-400 uppercase">Domain {q.d}</span>
                    </div>
                    <p className="text-2xl font-bold leading-snug mb-10">{q.q}</p>
                    <div className="grid gap-3">
                      {q.a.map((opt, aIdx) => (
                        <button key={aIdx} onClick={() => handleExamAnswer(i, aIdx)} className={`text-left p-6 rounded-2xl border-2 font-bold transition-all ${exam.answers[i] === aIdx ? 'border-blue-600 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-50 dark:border-gray-800 hover:border-blue-200'}`}>
                          {opt}
                        </button>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-white dark:bg-gray-900 p-16 rounded-[3rem] text-center space-y-10 animate-in zoom-in">
                <div className="flex justify-center">
                  <div className="p-8 bg-emerald-500/10 rounded-full text-emerald-500"><Trophy size={80} /></div>
                </div>
                <div>
                  <h2 className="text-7xl font-black tracking-tighter">{Math.round((Object.values(exam.answers).filter((v, i) => v === exam.questions[i].c).length / exam.questions.length) * 100)}%</h2>
                  <p className="text-xl font-bold text-gray-500 mt-2 tracking-tight">Simulator Attempt Complete</p>
                </div>
                <button onClick={() => setView('dashboard')} className="w-full bg-blue-600 text-white py-6 rounded-3xl font-black text-2xl shadow-xl shadow-blue-500/30">RETURN TO DASHBOARD</button>
              </div>
            )}
          </div>
        )}

      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
      `}} />
    </div>
  );
}

