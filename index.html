<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>28-Day SIE Exam Prep Course</title>
    <style>
        :root {
            --bg-body: #f4f6f8;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #2d3748;
            --text-muted: #718096;
            --primary: #3182ce;
            --primary-hover: #2b6cb0;
            --border: #e2e8f0;
            --success: #48bb78;
            --warning: #ed8936;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode {
            --bg-body: #1a202c;
            --bg-card: #2d3748;
            --bg-nav: #2d3748;
            --text-main: #f7fafc;
            --text-muted: #a0aec0;
            --primary: #63b3ed;
            --primary-hover: #4299e1;
            --border: #4a5568;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding-bottom: 40px; }

        /* Navigation */
        nav {
            position: sticky; top: 0; z-index: 100;
            background: var(--bg-nav);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
        }
        .nav-brand { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .nav-controls { display: flex; gap: 1rem; }
        
        button {
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 6px; border: none; font-weight: 600;
            background: var(--primary); color: white;
        }
        button:hover { background: var(--primary-hover); }
        button.secondary { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        body.dark-mode button.secondary { color: var(--primary); border-color: var(--primary); }

        /* Dashboard */
        .dashboard {
            max-width: 1200px; margin: 2rem auto; padding: 0 1rem;
            display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card); padding: 1.5rem; border-radius: 12px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .stat-card h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .big-number { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
        
        .progress-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-top: 1rem;
        }
        .mini-stat { background: rgba(0,0,0,0.03); padding: 0.8rem; border-radius: 8px; text-align: center; }
        body.dark-mode .mini-stat { background: rgba(255,255,255,0.05); }
        .mini-stat .label { display: block; font-size: 0.75rem; margin-bottom: 4px; color: var(--text-muted); }
        .mini-stat .value { font-weight: bold; font-size: 1.1rem; }

        /* Continuous Feed */
        .feed-container {
            max-width: 1200px; margin: 0 auto; padding: 0 1rem;
            display: flex; flex-wrap: wrap; gap: 1.5rem;
        }
        .day-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            flex: 1 1 300px; /* Responsive: grows but keeps min-width */
            display: flex; flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .day-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.02);
        }
        .day-tag {
            font-size: 0.75rem; font-weight: bold; padding: 2px 8px; border-radius: 12px;
            background: var(--border); color: var(--text-muted);
        }
        .day-content { padding: 1.5rem; flex-grow: 1; }
        .day-content h2 { margin-top: 0; font-size: 1.25rem; }
        .narrative { font-size: 0.95rem; line-height: 1.6; color: var(--text-muted); margin-bottom: 1.5rem; max-height: 200px; overflow-y: auto; }
        .day-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; }
        
        /* Checkbox custom */
        .check-container { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
        .check-box {
            width: 24px; height: 24px; border: 2px solid var(--primary); border-radius: 6px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .check-container.checked .check-box { background: var(--primary); }
        .check-container.checked .check-box::after { content: 'âœ“'; color: white; font-weight: bold; }

        /* Flashcard Overlay */
        #flashcard-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #flashcard-modal.active { display: flex; }
        .fc-container { perspective: 1000px; width: 90%; max-width: 600px; height: 400px; cursor: pointer; }
        .fc-card {
            width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-radius: 16px;
        }
        .fc-card.flipped { transform: rotateY(180deg); }
        .fc-face {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            display: flex; align-items: center; justify-content: center; text-align: center;
            padding: 2rem; font-size: 1.5rem; font-weight: 500;
            background: var(--bg-card); color: var(--text-main);
            border: 1px solid var(--border); border-radius: 16px;
        }
        .fc-back { transform: rotateY(180deg); background: var(--bg-nav); color: var(--primary); }
        .fc-controls { margin-top: 2rem; display: flex; gap: 1rem; }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .feed-container { flex-direction: column; }
            .day-card { flex: 1 1 100%; }
        }
    </style>
</head>
<body>

<nav>
    <div class="nav-brand">SIE Prep <span style="font-size:0.8em; opacity:0.6;">28-Day Plan</span></div>
    <div class="nav-controls">
        <button class="secondary" onclick="toggleFlashcards()">Flashcards</button>
        <button id="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
    </div>
</nav>

<section class="dashboard">
    <div class="stat-card">
        <h3>Weighted Mastery</h3>
        <div class="big-number" id="overall-score">0%</div>
        <p style="font-size:0.8rem; color:var(--text-muted);">Based on FINRA section weights</p>
    </div>
    <div class="stat-card">
        <h3>Section Breakdown</h3>
        <div class="progress-grid">
            <div class="mini-stat">
                <span class="label">Capital Markets (16%)</span>
                <span class="value" id="s1-score">0%</span>
            </div>
            <div class="mini-stat">
                <span class="label">Products & Risks (44%)</span>
                <span class="value" id="s2-score">0%</span>
            </div>
            <div class="mini-stat">
                <span class="label">Trading & Accounts (31%)</span>
                <span class="value" id="s3-score">0%</span>
            </div>
            <div class="mini-stat">
                <span class="label">Regulations (9%)</span>
                <span class="value" id="s4-score">0%</span>
            </div>
        </div>
    </div>
</section>

<main class="feed-container" id="feed">
    <!-- Days injected here via JS -->
</main>

<!-- Flashcard Interface -->
<div id="flashcard-modal">
    <div style="margin-bottom: 2rem; text-align: center;">
        <h2>Flashcard Mode</h2>
        <p style="color:var(--text-muted)">Spacebar to Flip â€¢ Arrows to Navigate</p>
    </div>
    <div class="fc-container" onclick="flipCard()">
        <div class="fc-card" id="active-card">
            <div class="fc-face fc-front" id="fc-front">Question</div>
            <div class="fc-face fc-back" id="fc-back">Answer</div>
        </div>
    </div>
    <div class="fc-controls">
        <button class="secondary" onclick="prevCard()">Previous</button>
        <button onclick="nextCard()">Next</button>
        <button class="secondary" style="margin-left: 2rem; border-color: red; color: red;" onclick="toggleFlashcards()">Exit</button>
    </div>
</div>

<script>
/**
 * DATA MODELS
 * Section 1: Knowledge of Capital Markets (16%)
 * Section 2: Understanding Products and Their Risks (44%)
 * Section 3: Trading, Customer Accounts, & Prohibited Activities (31%)
 * Section 4: Overview of Regulatory Framework (9%)
 */

const COURSE_DATA = [
    // --- WEEK 1 ---
    {
        day: 1,
        title: "The Regulatory Ecosystem",
        section: 4,
        narrative: "Introduction to the SIE. The Securities Industry Essentials (SIE) exam assesses basic knowledge of the securities industry concepts fundamental to working in the industry. Key regulators include the SEC (government), FINRA (SRO), and MSRB (SRO). Focus on the mission of the SEC: protect investors, maintain fair, orderly, and efficient markets, and facilitate capital formation.",
        questions: [
            { q: "What does SRO stand for?", a: "Self-Regulatory Organization (e.g., FINRA, MSRB)" },
            { q: "What is the primary mission of the SEC?", a: "Protect investors and maintain fair markets." }
        ]
    },
    {
        day: 2,
        title: "Economic Factors",
        section: 1,
        narrative: "Understanding GDP, Inflation, and the Business Cycle. Expansion, Peak, Contraction, Trough. The Fed's tools: Open Market Operations (buying bonds loosens money supply), Discount Rate, and Reserve Requirements. Fiscal Policy vs. Monetary Policy.",
        questions: [
            { q: "Who controls Monetary Policy?", a: "The Federal Reserve Board (The Fed)" },
            { q: "What happens to interest rates if the Fed buys securities?", a: "Interest rates decrease (Money supply increases)." }
        ]
    },
    {
        day: 3,
        title: "Primary vs. Secondary Markets",
        section: 1,
        narrative: "Primary Market: Issuer sells to investors (IPO, APO). Secondary Market: Investor to Investor (NYSE, Nasdaq). Role of the Underwriter (Firm Commitment vs. Best Efforts).",
        questions: [
            { q: "Where do IPOs take place?", a: "The Primary Market" },
            { q: "What is a 'Best Efforts' underwriting?", a: "Underwriter acts as agent; unsold shares return to issuer." }
        ]
    },
    {
        day: 4,
        title: "Equities (Common vs. Preferred)",
        section: 2,
        narrative: "Equity securities represent ownership interest in a corporation. Common stock: Voting rights, capital appreciation, dividends (not guaranteed). Preferred stock: Fixed dividend, priority over common in bankruptcy, usually no voting rights.",
        questions: [
            { q: "Which type of voting allows a shareholder to cast all their votes for one director?", a: "Cumulative Voting" },
            { q: "Describe the primary benefit of Cumulative Preferred Stock.", a: "Missed dividends accumulate and must be paid in arrears before common." }
        ]
    },
    {
        day: 5,
        title: "Debt Securities & The Yield Seesaw",
        section: 2,
        narrative: "Bonds are loans. Key Concept: Bond prices and Interest Rates have an INVERSE relationship. If rates go up, prices go down. Yield to Maturity (YTM) vs Current Yield. Nominal Yield is the coupon rate.",
        questions: [
            { q: "If interest rates rise, what happens to the price of existing bonds?", a: "The price decreases (Inverse Relationship)." },
            { q: "Which bond has the most interest rate risk?", a: "Long-term, zero-coupon bonds." }
        ]
    },
    {
        day: 6,
        title: "Corporate & Muni Bonds",
        section: 2,
        narrative: "Corporate Debt: Secured (Mortgage, Equipment Trust) vs Unsecured (Debentures). Municipal Bonds: GO Bonds (backed by taxes) vs Revenue Bonds (backed by user fees). Tax equivalent yield calculations.",
        questions: [
            { q: "What backs a General Obligation (GO) bond?", a: "Full faith and credit (taxing power) of the municipality." },
            { q: "Are Muni bond interest payments federal tax-free?", a: "Yes, generally." }
        ]
    },
    {
        day: 7,
        title: "Review & Cumulative Assessment 1",
        section: 1, // Weighted as general knowledge
        narrative: "First cumulative review. Focus on the relationship between Economic factors (Day 2) and Bond prices (Day 5). Re-read sections on Primary Markets if score < 70%.",
        questions: [
            { q: "What is a 'tombstone ad'?", a: "An announcement of a new security issue (minimal info)." },
            { q: "Define 'Stagflation'.", a: "High inflation combined with high unemployment." }
        ]
    },
    
    // --- WEEK 2 ---
    {
        day: 8,
        title: "Options Fundamentals (Calls/Puts)",
        section: 2,
        narrative: "Derivatives. Call = Right to Buy. Put = Right to Sell. Long = Buyer (Holder). Short = Seller (Writer). The Option Premium = Intrinsic Value + Time Value.",
        questions: [
            { q: "If you own a stock and want to protect downside risk, what do you buy?", a: "A Long Put (Protective Put)." },
            { q: "What is the max loss for a Long Call?", a: "The premium paid." }
        ]
    },
    {
        day: 9,
        title: "Options Strategies & Hedging",
        section: 2,
        narrative: "Covered Call: Long Stock + Short Call (generate income). Protective Put: Long Stock + Long Put (insurance). Breakdown of Breakeven points.",
        questions: [
            { q: "Why would an investor write a covered call?", a: "To generate income in a flat/neutral market." },
            { q: "Breakeven for a Call Buyer?", a: "Strike Price + Premium." }
        ]
    },
    {
        day: 10,
        title: "Packaged Products: Mutual Funds",
        section: 2,
        narrative: "Open-End Funds. Continuous primary offering. Priced at NAV. Forward pricing (price calculated at end of day). Sales loads (Class A, B, C shares).",
        questions: [
            { q: "What price does a Mutual Fund investor pay?", a: "POP (Public Offering Price) = NAV + Sales Charge." },
            { q: "Which share class has a front-end load?", a: "Class A Shares." }
        ]
    },
    {
        day: 11,
        title: "ETFs and Closed-End Funds",
        section: 2,
        narrative: "Closed-End: Fixed number of shares, trade on exchange (supply/demand pricing). ETFs: Trade like stocks, track an index, tax efficient. REITs: Real Estate Investment Trusts.",
        questions: [
            { q: "Can Closed-End funds trade below NAV?", a: "Yes, because they trade based on supply and demand." },
            { q: "Do REITs pass through losses to investors?", a: "No, only gains." }
        ]
    },
    {
        day: 12,
        title: "Variable Annuities",
        section: 2,
        narrative: "Insurance product + Security. Separate Account invests in sub-accounts (mutual funds). Tax-deferred growth. LIFO taxation on withdrawal. Mortality and expense charges.",
        questions: [
            { q: "Who assumes the investment risk in a Variable Annuity?", a: "The Investor." },
            { q: "Is a Variable Annuity a security?", a: "Yes, must be sold with a prospectus." }
        ]
    },
    {
        day: 13,
        title: "Direct Participation Programs (DPPs)",
        section: 2,
        narrative: "Limited Partnerships. General Partner (manages, unlimited liability) vs Limited Partner (passive, limited liability). Flow-through of income and losses.",
        questions: [
            { q: "What is the maximum liability for a Limited Partner?", a: "Their initial investment + committed funds." },
            { q: "What is the main advantage of a DPP?", a: "Flow-through of tax consequences (passive losses offset passive gains)." }
        ]
    },
    {
        day: 14,
        title: "Review & Cumulative Assessment 2",
        section: 2,
        narrative: "Mid-point review. Heavy focus on Investment Company Act of 1940 and Product risks. Ensure distinction between Open-End (Mutual Funds) and Closed-End is clear.",
        questions: [
            { q: "Definition of a 'Face Amount Certificate' company.", a: "Issuer guarantees payment of a stated sum at a fixed date." },
            { q: "What is a 12b-1 fee?", a: "Annual fee for marketing and distribution costs." }
        ]
    },

    // --- WEEK 3 ---
    {
        day: 15,
        title: "Trading Markets & Orders",
        section: 3,
        narrative: "Market Orders (Speed) vs Limit Orders (Price). Stop Orders (Trigger + Execution). Day orders vs GTC. The Bid-Ask Spread: Market Maker buys at Bid, sells at Ask.",
        questions: [
            { q: "What order guarantees a price but not execution?", a: "Limit Order." },
            { q: "A Sell Stop is placed...?", a: "Below the current market price." }
        ]
    },
    {
        day: 16,
        title: "Customer Accounts (Cash vs Margin)",
        section: 3,
        narrative: "Cash Account: Pay in full (Reg T + 2). Margin Account: Borrowing money. Regulation T = 50% initial margin. Minimum maintenance requirements.",
        questions: [
            { q: "Who sets Regulation T?", a: "The Federal Reserve Board." },
            { q: "What is the penalty for freeriding?", a: "Account frozen for 90 days." }
        ]
    },
    {
        day: 17,
        title: "Account Types & Registrations",
        section: 3,
        narrative: "Individual, Joint (JTWROS vs TIC). Custodial (UGMA/UTMA). Corporate (needs Corp Resolution). Discretionary accounts (needs Power of Attorney).",
        questions: [
            { q: "In a JTWROS account, if one party dies, what happens?", a: "Assets pass to the survivor avoiding probate." },
            { q: "Who is the owner of a UTMA account?", a: "The Minor (beneficial owner)." }
        ]
    },
    {
        day: 18,
        title: "Retirement Plans",
        section: 3,
        narrative: "Retirement Plans: Traditional IRA: Pre-tax contributions, tax-deferred growth, taxed on withdrawal. Roth IRA: After-tax contributions, tax-free withdrawal. 401(k) plans. Qualified vs Non-Qualified.",
        questions: [
            { q: "At what age do RMDs begin for a Traditional IRA?", a: "73 (under SECURE Act 2.0)." },
            { q: "What is the penalty for early withdrawal (pre-59.5)?", a: "10% + Ordinary Income Tax." }
        ]
    },
    {
        day: 19,
        title: "Market Manipulation & Prohibited Acts",
        section: 3,
        narrative: "Market Rumors, Pump and Dump, Front Running (trading ahead of client), Churning (excessive trading), Freeriding. Insider Trading Act of 1988.",
        questions: [
            { q: "Define 'Front Running'.", a: "Broker trades for own account before a large client order." },
            { q: "What is 'Churning'?", a: "Excessive trading to generate commissions." }
        ]
    },
    {
        day: 20,
        title: "Ethics & Conduct Rules",
        section: 3,
        narrative: "Gifts and Gratuities ($100 limit). Non-cash compensation. Outside Business Activities (OBA). Private Securities Transactions (Selling Away).",
        questions: [
            { q: "Can a Rep borrow money from a client?", a: "Generally No, unless immediate family or lending institution." },
            { q: "What is the limit for business gifts?", a: "$100 per person per year." }
        ]
    },
    {
        day: 21,
        title: "Review & Cumulative Assessment 3",
        section: 3,
        narrative: "Focus on Trading and Accounts. Re-visit Margin math (Reg T) and Order types (Stop vs Limit).",
        questions: [
            { q: "Difference between TIC and JTWROS?", a: "TIC has no right of survivorship; JTWROS does." },
            { q: "What is 'Backing Away'?", a: "Market maker failing to honor a firm quote." }
        ]
    },

    // --- WEEK 4 ---
    {
        day: 22,
        title: "SIPC & FDIC",
        section: 4,
        narrative: "SIPC (Securities Investor Protection Corp) protects against Broker-Dealer bankruptcy. $500k coverage total, up to $250k cash. FDIC protects bank deposits.",
        questions: [
            { q: "Does SIPC protect against market loss?", a: "No, only BD bankruptcy." },
            { q: "What is the max cash coverage under SIPC?", a: "$250,000." }
        ]
    },
    {
        day: 23,
        title: "Registration & Continuing Ed",
        section: 4,
        narrative: "Form U4 (Registration), U5 (Termination). Regulatory Element CE (Annual). Firm Element CE. Statutory Disqualification (e.g., felony conviction within 10 years).",
        questions: [
            { q: "When must Form U4 be updated?", a: "Within 30 days of a change." },
            { q: "How long does FINRA retain jurisdiction after U5?", a: "2 Years." }
        ]
    },
    {
        day: 24,
        title: "New Issues & Exemptions",
        section: 4,
        narrative: "Securities Act of 1933 (Paper Act). Exempt securities: Gov, Muni, Short term debt. Exempt Transactions: Reg D (Private Placement), Rule 144 (Control/Restricted stock).",
        questions: [
            { q: "What is the holding period for Restricted Stock?", a: "6 months." },
            { q: "Who is an 'Accredited Investor'?", a: "$1M net worth (excluding home) or $200k income." }
        ]
    },
    {
        day: 25,
        title: "Drill: The Options Matrix",
        section: 2,
        narrative: "Deep dive drill. Create a 4-quadrant matrix. Calls: Long (Right to buy), Short (Obligation to sell). Puts: Long (Right to sell), Short (Obligation to buy). Master 'Moneyness' (ITM, OTM, ATM).",
        questions: [
            { q: "Call is In-the-Money (ITM) when...", a: "Market Price > Strike Price." },
            { q: "Put is In-the-Money (ITM) when...", a: "Market Price < Strike Price." }
        ]
    },
    {
        day: 26,
        title: "Drill: Risks & Returns",
        section: 2,
        narrative: "Reviewing Investment Risks. Systematic (Market, Interest Rate, Inflation) vs Non-Systematic (Business, Regulatory). Diversification reduces Non-Systematic risk. Beta measures volatility.",
        questions: [
            { q: "Can you diversify away Systematic Risk?", a: "No." },
            { q: "What risk does a Zero-Coupon bond eliminate?", a: "Reinvestment Rate Risk." }
        ]
    },
    {
        day: 27,
        title: "Mock Exam 1 (75 Questions)",
        section: 1, // General Review
        narrative: "Simulated exam conditions. 1 hour 45 minutes. No notes. Review results immediately after. Flag weak sections.",
        questions: [
            { q: "Is this a real exam?", a: "It is a simulation." },
            { q: "Pass score?", a: "70%" }
        ]
    },
    {
        day: 28,
        title: "Final Mock Exam & Readiness",
        section: 1, // General Review
        narrative: "Final Readiness Check. Do not study new material. Rest well. Bring ID to Prometric/Pearson center.",
        questions: [
            { q: "Are calculators allowed?", a: "Centers provide them." },
            { q: "Good luck!", a: "You got this." }
        ]
    }
];

// App Logic
const AppState = {
    key: 'sie_app_v1',
    data: {
        completedDays: [], // array of day numbers
        theme: 'light'
    },
    load() {
        const stored = localStorage.getItem(this.key);
        if (stored) {
            this.data = JSON.parse(stored);
            if(!this.data.completedDays) this.data.completedDays = [];
        }
        this.applyTheme();
    },
    save() {
        localStorage.setItem(this.key, JSON.stringify(this.data));
        updateDashboard();
    },
    toggleDay(dayNum) {
        const index = this.data.completedDays.indexOf(dayNum);
        if (index === -1) {
            this.data.completedDays.push(dayNum);
        } else {
            this.data.completedDays.splice(index, 1);
        }
        this.save();
    },
    applyTheme() {
        if (this.data.theme === 'dark') {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
};

// Dashboard Logic
function updateDashboard() {
    const weights = { 1: 0.16, 2: 0.44, 3: 0.31, 4: 0.09 };
    // Count total days in each section
    const sectionCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };
    COURSE_DATA.forEach(d => sectionCounts[d.section]++);

    // Count completed days in each section
    const completedCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };
    COURSE_DATA.forEach(d => {
        if (AppState.data.completedDays.includes(d.day)) {
            completedCounts[d.section]++;
        }
    });

    let totalWeightedScore = 0;

    // Calculate per section
    for (let i = 1; i <= 4; i++) {
        const rawPct = sectionCounts[i] === 0 ? 0 : (completedCounts[i] / sectionCounts[i]);
        const weightedContribution = rawPct * weights[i];
        totalWeightedScore += weightedContribution;

        // Update UI for section breakdown
        document.getElementById(`s${i}-score`).innerText = `${Math.round(rawPct * 100)}%`;
    }

    // Update Overall
    document.getElementById('overall-score').innerText = `${Math.round(totalWeightedScore * 100)}%`;
}

// Render Feed
function renderFeed() {
    const container = document.getElementById('feed');
    container.innerHTML = '';
    
    COURSE_DATA.forEach(day => {
        const isChecked = AppState.data.completedDays.includes(day.day) ? 'checked' : '';
        
        const card = document.createElement('div');
        card.className = 'day-card';
        card.innerHTML = `
            <div class="day-header">
                <span style="font-weight:800; color:var(--primary);">Day ${day.day}</span>
                <span class="day-tag">Section ${day.section}</span>
            </div>
            <div class="day-content">
                <h2>${day.title}</h2>
                <div class="narrative">${day.narrative}</div>
            </div>
            <div class="day-footer">
                <div class="check-container ${isChecked}" onclick="toggleCheck(this, ${day.day})">
                    <span style="margin-right:8px; font-weight:600; color:var(--text-muted)">Complete</span>
                    <div class="check-box"></div>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function toggleCheck(el, day) {
    el.classList.toggle('checked');
    AppState.toggleDay(day);
}

// Theme Logic
function toggleTheme() {
    AppState.data.theme = AppState.data.theme === 'light' ? 'dark' : 'light';
    AppState.save(); // save pref
    AppState.applyTheme();
}

// Flashcard Logic
let fcIndex = 0;
let fcList = [];
let isFlipped = false;

function buildFlashcardList() {
    fcList = [];
    COURSE_DATA.forEach(day => {
        if(day.questions) {
            day.questions.forEach(q => fcList.push(q));
        }
    });
    // Shuffle
    fcList.sort(() => Math.random() - 0.5);
}

function toggleFlashcards() {
    const modal = document.getElementById('flashcard-modal');
    const isActive = modal.classList.contains('active');
    
    if (!isActive) {
        buildFlashcardList();
        fcIndex = 0;
        showCard();
        modal.classList.add('active');
        document.addEventListener('keydown', handleFcKey);
    } else {
        modal.classList.remove('active');
        document.removeEventListener('keydown', handleFcKey);
    }
}

function showCard() {
    isFlipped = false;
    const card = document.getElementById('active-card');
    card.classList.remove('flipped');
    
    // Tiny timeout to update text so user doesn't see swap
    setTimeout(() => {
        const q = fcList[fcIndex];
        document.getElementById('fc-front').innerText = q.q;
        document.getElementById('fc-back').innerText = q.a;
    }, 200);
}

function flipCard() {
    const card = document.getElementById('active-card');
    isFlipped = !isFlipped;
    if(isFlipped) card.classList.add('flipped');
    else card.classList.remove('flipped');
}

function nextCard() {
    if (fcIndex < fcList.length - 1) {
        fcIndex++;
        showCard();
    } else {
        alert("You've gone through all loaded cards! Reshuffling...");
        buildFlashcardList();
        fcIndex = 0;
        showCard();
    }
}

function prevCard() {
    if (fcIndex > 0) {
        fcIndex--;
        showCard();
    }
}

function handleFcKey(e) {
    if(e.code === 'Space') {
        e.preventDefault(); // stop scrolling
        flipCard();
    }
    if(e.code === 'ArrowRight') nextCard();
    if(e.code === 'ArrowLeft') prevCard();
}

// Init
window.addEventListener('DOMContentLoaded', () => {
    AppState.load();
    renderFeed();
    updateDashboard();
    
    // Debug Output
    console.log("App Initialized");
    console.log("Total Modules:", COURSE_DATA.length);
    console.log("Section 2 Weight Check:", (0.44).toLocaleString(undefined,{style:'percent'}));
});

</script>
</body>
</html>

